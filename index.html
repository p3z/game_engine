<html>
  <head>
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/utils.css">
    <link rel="stylesheet" href="./css/backgrounds.css">
    <link rel="stylesheet" href="./css/animations.css">
    <link rel="stylesheet" href="./css/style.css">
    
    
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  </head>
  <body>
    <div class="control_panel">
        <button class="js-run_test dev-btn">
            Run test
        </button>
      
      <button class="js-reset dev-btn">
            Reset
       </button>

       <button class="js-clear-canvas hide dev-btn">
        Clear
      </button>

       <button class="js-test dev-btn">
            Test
       </button>
    </div> <!-- end control panel-->
    <div id="main_view"></div>


    <div class="scoreboard ui-board hide">
      <span class="js-score"></span>
    </div>


    <div class="lifeboard ui-board hide">
      <div class="lifeboard-meter1" data-value="100"></div>
      <img class="lifeboard-avatar hide" src="./img/rocket-icon.png" >
      &nbsp; x &nbsp;
      <span class="js-lives"></span>
    </div>

    <!-- todo: audio elements suffice for now but shd probs use a library -->
    <audio class="js-backing-track">
      <source src="./audio/track1.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>

    <audio class="js-projectile-track-1">
      <source src="./audio/laser_1.wav" type="audio/wav">
      Your browser does not support the audio element.
    </audio>
    
    <!-- Temp do this inline to avoid p5/module weirdness -->

       <!-- utils.js -->
       <script>
        function random_num(floor, ceil){
  
  return Math.floor(Math.random() * (ceil - floor + 1) + floor);
  
  } // end random_num
  
  // Returns an array of rgba color objects
  function random_rgba(qty = 1, solid = false){
  
    let colors = [];
    
    for(let i = 0; i < qty; i++){
    
        let color = {};
    
        let r = random_num(0, 255);
        let g = random_num(0, 255);
        let b = random_num(0, 255);
        let a = random_num(0, 100) / 100;
    
        let val = (!solid) ? `rgba(${r}, ${g}, ${b}, ${a})` : `rgba(${r}, ${g}, ${b})`;
    
        colors.push(val);
    }
    
    return colors;
  
  }
  
  function random_hex(with_hash = false){
  const letters = '0123456789ABCDEF';
  let color = with_hash ? '#' : '';
  
  for (let i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
  }
  
  return color;
  }
  
  function rand_arr_select(arr){
  const index = Math.floor(Math.random() * arr.length);
  return arr[index];
  }
      </script>

    <!-- settings.js -->
    <script>
      const MAX_STAR_THRESHOLD = 100;
      const MIN_STAR_SIZE = 1;
      const MAX_STAR_SIZE = 8;
      const MIN_PLANET_SIZE = 20;
      const MAX_PLANET_SIZE = 50;
      const MAX_STAR_SPARSITY = 100;
      const DEFAULT_SPEED = random_num(100, 500);
      const PLANET_PASSING_THRESHOLD = 3; // out of 100 stars, this is the % chance it'll be a planet instead (3% is the usual setting)
      const STAR_COLORS = [
        '#FFFFFF', // white
        '#FFFFCC', // pale yellow
        '#FFFF99', // light yellow
        '#FFFF66', // yellow
        '#E6E6E6', // light gray
        '#CCCCCC', // gray
        '#99CCFF', // light blue
        '#66CCFF', // blue
        '#FF99CC', // light pink
        '#FF66CC'  // pink
      ];

      const PLANET_COLORS = [
        "#F0A1A1", // Pinkish
        "#A1F0A1", // Greenish
        "#A1A1F0", // Bluish
        "#F0F0A1", // Yellowish
        "#DAA520"  // Goldenrod
      ];
    </script>

 

<!-- assorted -->
<script>
  function select_spawn_point(view, location = []){
    let view_width = view.clientWidth;
    let view_height = view.clientHeight;
    
    
    let x_loc, y_loc;
    
    if(location.length == 0){
      // No location specified, Pick a random place between each end of the view
      x_loc = random_num(0, view_width);
      y_loc = random_num(0, view_height);
      
    } else {
      // Assign one of the selected locations
      x_loc = location[0];
      y_loc = location[1];
    }

    let spawn_point = {
      x_loc: x_loc,
      y_loc: y_loc
    };
    
    //console.log(spawn_point)
    
    return spawn_point;
  }
</script>

<!-- main -->
    <script>
      const run_test_btn = document.querySelector('.js-run_test');
      const reset_btn = document.querySelector('.js-reset');
      const test_btn  = document.querySelector('.js-test');
      const main_view = document.querySelector('#main_view');
      const clear_canvas_btn = document.querySelector(".js-clear-canvas");
      const origin = -100; // above the top of the canvas so things can animate in
      const player_avatar_size = 50;
      let run_animation = true;
      let stars = [];
      let planets = [];
      let projectiles = [];
      let player_avatar;
      let player_1_spawned = false;
      let playerRadius = 25;
      let playerX, playerY;
      

      function preload() {
        player_avatar = loadImage('./img/rocket-icon-wht.png');          
      }

      function init_canvas() { // dont call this fn 'setup', you'll conflict with p5 defaults and invoke it immediately!
          let canvas = createCanvas(windowWidth, windowHeight);          
          background(0);
          canvas.parent('main_view');          
          clear_canvas_btn.classList.remove("hide");
          player_avatar.resize(player_avatar_size, player_avatar_size);
      }
      const backing_track = document.querySelector('.js-backing-track');
      const laser1 = document.querySelector('.js-projectile-track-1');


      run_test_btn.addEventListener('click', function() {
        backing_track.play();
        init_canvas();
        run_animation = true;

      });
 

      reset_btn.onclick = () => {
        reset_view()
        clear_canvas_btn.classList.add("hide");
        stop_audio(backing_track);
      }

      function generate_celestial(type){

        let size, potential_cols;

        switch(type){
          case 'planet':
          size = random_num(MIN_PLANET_SIZE, MAX_PLANET_SIZE);
          potential_cols = PLANET_COLORS;    
          break;

          case 'star':
          default: 
          size = random_num(MIN_STAR_SIZE, MAX_STAR_SIZE);
          potential_cols = STAR_COLORS;        

        }

        
        
        let celestial_obj = {
            x: random(width), 
            y: -size, // spawn it above the canvas
            size: size,
            speed: random_num(0, 10),
            color: rand_arr_select(potential_cols)         
          };
          

          return celestial_obj;

      }

      function animate_celestials(celestials,){   

          for (let i = celestials.length - 1; i >= 0; i--) {

            let current = celestials[i];            
            current.y += current.speed; // Move the celestial downwards

            fill(current.color); // Set the fill color to the celestial's color
            noStroke();            
            ellipse(current.x, current.y, current.size, current.size); // Draw the celestial

            // Remove celestials that have moved off the canvas
            if (current.y > height + current.size / 2) {
              celestials.splice(i, 1);
            }

          }

        }

      function animate_projectiles(projectiles){
        for (let i = projectiles.length - 1; i >= 0; i--) {

            let shot = projectiles[i];
            let fire_origin = shot.y - player_avatar.height;

            fill(shot.color); // Set the fill color to the celestial's color
            noStroke(); 
            ellipse(shot.x, fire_origin, shot.width, shot.height);

            // Move the shot upwards
            shot.y -= 15; // Adjust the speed as needed

            // Remove circles that have moved out of the canvas
            if (shot.y + shot.diameter / 2 < 0) {
              projectiles.splice(i, 1);
            }
        }
      }

     
        

      test_btn.onclick = () => {
        player_1_spawned = !player_1_spawned;
      }

      clear_canvas_btn.onclick = () => {
        background(0); // Clear the canvas by setting the background color
        stars = [];
        planets = [];
        run_animation = false;
        player_1_spawned = false;
      }

      function reset_view() {
        main_view.innerHTML = "";
      }

  
      

      function get_percentage(num, percentage){
        return num / 100 * percentage;
      }
      

      function draw() {
          
        background(0); // Clear the background

        if(run_animation){

          let sparsity = random_num(0, MAX_STAR_SPARSITY); // decide if we should spawn a star this frame

          switch(true){
            case (sparsity < get_percentage(MAX_STAR_SPARSITY, 1)): // 1% chance
              let new_planet = generate_celestial('planet');
              planets.push(new_planet);
              break;

            case (sparsity < get_percentage(MAX_STAR_SPARSITY, 50)): // 50% chance
              // let star_qty = random_num(0 ,3); // if we want to create more than one star per frame

              // for(let i = 0; i < star_qty; i++){
                let new_star = generate_celestial();
                stars.push(new_star);
              //}
              break;
          }
          
          
          animate_celestials(stars);
          animate_celestials(planets);
      
        }
  
        if (player_1_spawned) {

            // Calculate avatar pos, centered on the cursor
            let imageX = mouseX - player_avatar.width / 2;
            let imageY = mouseY - player_avatar.height / 2;

            // Draw a border around the player image
            // stroke(255, 0, 0); // Red border color
            // strokeWeight(2); // Border width
            // noFill(); // No fill inside the border
            // rect(imageX, imageY, player_avatar.width, player_avatar.height);

            // Draw the player circle with the image background
            image(player_avatar, imageX, imageY, player_avatar_size, player_avatar_size);
            animate_projectiles(projectiles);
            
        }
          
      }

      function spawn_projectile(color){
        // Create a new circle at the mouse click location
        let shot = {
          x: mouseX,
          y: mouseY,
          height: 80,
          width: 5,
          color: color
        };

        // Add the new circle to the array
        projectiles.push(shot);

      }

      function mousePressed() {
        spawn_projectile("rgba(255, 255, 0, 0.5)")

        if(player_1_spawned){
          laser1.play();
        }
        
      }
      
      function stop_audio(audio){
        audio.pause();
        audio.currentTime = 0;
      }

        



    </script>
  </body>
</html>